<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Flow Annealed Importance Sampling Bootstrap | Yorgos Deligiannidis </title> <meta name="author" content="Yorgos Yorgos"> <meta name="description" content="Notes on FAB"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ziorzis.github.io/blog/2024/FAB/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Yorgos Deligiannidis </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Bio </a> </li> <li class="nav-item"> <a class="nav-link" href="/assets/pdf/CV.pdf">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Flow Annealed Importance Sampling Bootstrap</h1> <p class="post-meta"> Written on November 17, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"><a href="#tldr">TL;DR</a></li> <li class="toc-entry toc-h2"> <a href="#setup">Setup</a> <ul> <li class="toc-entry toc-h3"><a href="#kl-example">KL Example</a></li> </ul> </li> <li class="toc-entry toc-h2"><a href="#main-idea-of-fab">Main Idea of FAB</a></li> <li class="toc-entry toc-h2"><a href="#paper-details">Paper Details</a></li> <li class="toc-entry toc-h2"><a href="#replay-buffer">Replay Buffer</a></li> <li class="toc-entry toc-h2"><a href="#todo">TODO</a></li> </ul> </div> <hr> <div id="markdown-content"> <p>My notes on <a href="https://arxiv.org/abs/2111.11510" rel="external nofollow noopener" target="_blank">Bootstrap Your Flow</a> and <a href="https://arxiv.org/abs/2208.01893" rel="external nofollow noopener" target="_blank">Flow Annealed Importance Sampling Bootstrap</a> (FAB).</p> <h2 id="tldr">TL;DR</h2> <p>Training parametric distributions \(q_{\theta}\) to approximate a target density \(p\) often suffers from high-variance objectives. These objectives can sometimes be rewritten via an Annealed Importance Sampling (AIS) estimator. Choosing the AIS target distribution in a smart way can help reduce the variance of these objectives.</p> <h2 id="setup">Setup</h2> <p>Suppose we want to approximate some target density \(p\). We assume access to a parametric family of densities \(q_{\theta}\) that we can sample from and evaluate. For example, \(q_{\theta}\) may be parametrized as a normalizing flow. Given some divergence \(D\) between probability distributions, we will select \(\theta\) to minimize the divergence \(D\) between \(q_{\theta}\) and \(p\).</p> <h3 id="kl-example">KL Example</h3> <p>Consider the classical example of the KL divergence \(\text{KL}(q \| p) = \int q(x)\log \frac{q(x)}{p(x)}dx\). We could either try and minimize \(\text{KL}(q_{\theta} \| p)\) or \(\text{KL}(p \| q_{\theta})\). Let’s consider \(\text{KL}(q_{\theta} \| p)\). This objective is tractable to optimize (yay!) since we can sample from \(q_{\theta}\). However, it exhibits mode-seeking behaviour. This is because \(\log \frac{q_{\theta}(x)}{p(x)}\) blows up when \(q_{\theta}\) assigns high density to \(x\) such that \(p(x)\) is small. Hence, minimizing \(\text{KL}(q_{\theta} \| p)\) will choose a \(q_{\theta}\) that only assigns mass where \(p\) has sufficient density. The optimal \(q_{\theta}\) will avoid placing any mass where \(p\) does not have a lot. So, if \(p\) is multi-modal, \(q_{\theta}\) will most likely just learn a few of these modes and place all mass in them. We drop modes as a result. This is a downside of the objective.</p> <p>On the other hand, if we optimize \(\text{KL}(p \| q_{\theta})\), then this exhibits mode-covering behaviour. This is because \(\log \frac{p(x)}{q_{\theta}(x)}\) will blow up when \(p\) assigns a lot of mass to \(x\), but \(q_{\theta}\) doesn’t. So, the learned \(q_{\theta}\) will try and place mass everywhere that \(p\) has mass (yay!). However, the issue is that we now need samples from \(p\) to train with this objective. We might not have access to samples from \(p\) though (or getting samples could be very expensive). So, we need to find other ways of training this objective without relying on samples from \(p\).</p> <p>We could try to use Importance Sampling (IS) and rewrite the objective as \(\mathbb{E}_{x \sim q_{\theta}}[\frac{p(x)}{q_{\theta}(x)}\log \frac{p(x)}{q_{\theta}(x)}]\). We still have the mode-covering behaviour (since the objective itself has not changed) and we can now train on samples from \(q_{\theta}\). However, the variance of our IS estimator will be very large. That is, \(\text{Var}_{x \sim q_{\theta}}(\frac{p(x)}{q_{\theta}(x)}\log \frac{p(x)}{q_{\theta}(x)}))\) can be big and make optimization tricky. In particular, we know that the expected value is positive (since KL is positive). Observe that \(\frac{p(x)}{q_{\theta}(x)}\log \frac{p(x)}{q_{\theta}(x)}\) is positive for \(x\) such that \(p(x) &gt; q_{\theta}(x)\). However, if \(q_{\theta}\) is very different from \(p\) (for example, at the onset of training), then most samples \(x\) from \(q_{\theta}\) will be such that \(q_{\theta}(x) &gt; p(x)\) and thus \(\frac{p(x)}{q_{\theta}(x)}\log \frac{p(x)}{q_{\theta}(x)} &lt; 0\). Said another way, for most \(x \sim q_{\theta}\), the integrand will be negative. To compensate, once in a while the integrand will be a very large positive value. This makes training challenging (have high variance).</p> <h2 id="main-idea-of-fab">Main Idea of FAB</h2> <p>This tradeoff exists for many divergences \(D\), which can often be written in the form \(D(q \| p) = \int q(x) f(q(x), p(x))dx\) for some \(f\). \(D(q \| p)\) will often be mode-seeking, whereas \(D(p \|q)\) will either require samples from \(p\) or have high variance if using a modified IS objective for training. (This is exactly what we saw in the KL example above.)</p> <p>FAB considers the case of a mode-covering \(D(p \|q_{\theta})\). Note that for any density \(g\), we have</p> \[D(p \|q_{\theta}) = \mathbb{E}_{x \sim g}[\frac{p}{g}f(p, q_{\theta})].\] <p>As discussed for the KL example, often, if we set \(g = q_{\theta}\), then the IS estimator has high variance. However, we know that the optimal \(g\) (the one minimizing the variance) is \(g_*(x) \propto p(x)f(p(x), q_{\theta}(x))\). Sampling from this optimal \(g_{*}\) is usually not tractable (which is what we would want for IS). So, FAB suggests using AIS to estimate the above objective. In particular, AIS will be initialized at \(q_{\theta}\) and will target \(g_{*}\). The output of AIS is a collection of samples \(x_1, \dots, x_n\) and corresponding weights \(w_1, \dots , w_n\). If AIS is implemented well, then the particles \(x_i\) will be distributed approximately as \(g_{*}\). Regardless though, AIS guarantees us that the weights \(w_i\) are chosen such that for any function \(h\), we have</p> \[\mathbb{E}_{\text{AIS}}[w_i h(x_i)] = \int h(x) g_{*}(x)dx,\] <p>where the expectation is over the randomness of the AIS sampling procedure. Therefore we can now use the AIS outputted samples and weights to obtain an unbiased estimator of our training objective (i.e. we take \(h = \frac{p}{g_{*}}f(p, q_{\theta})\)). Since the samples are approximately from \(g_{*}\), the variance of our estimator should be small and so training will be tractable!</p> <h2 id="paper-details">Paper Details</h2> <p>Both papers specifically focus on using the \(\alpha\)-divergence with \(\alpha = 2\). Up to constants, this is given by</p> \[D_{2}(p \|q_{\theta}) = \int \frac{p^2(x)}{q_{\theta}(x)}dx.\] <p>This objective is a natural one as it is mode-covering and it corresponds to minimizing the variance of the importance weights \(\frac{p(x)}{q_{\theta}(x)}\). (In particular, after training \(q_{\theta}\), if IS is used to estimate expectations w.r.t. \(p\) so that the estimator is unbiased, then the weights will have low variance.) As discussed, this objective can be estimated with either samples from \(p\) or \(q_{\theta}\). However, the estimator will have lower variance if we use \(p\). So, the original paper Bootstrap Your Flow paper suggests using AIS to target \(p\). On the other hand, the Annealed Importance Sampling Bootstrap paper suggests using AIS to target \(g_{*} \propto \frac{p^2}{q_{\theta}}\) (i.e. choosing \(g\) that will induce the minimal variance estimator).</p> <p>This method is performing a sort of bootstrapping since as the flow \(q_{\theta}\) improves, the initial samples to AIS will be closer to \(p\) which should make the final samples closer to \(\frac{p^2}{q}\) and so the AIS estimator will have lower variance. So, the expected values computed via AIS will be improved, and so the gradient information passed to optimizing \(q_{\theta}\) will be better, and thus \(q_{\theta}\) will become even closer to \(p\).</p> <p>The paper explores using both the original weights \(w_i\) from AIS and the self-normalized weights \(\frac{w_i}{\sum_j w_j}\). They found that using the self-normalized weights improved training. (Just watch out for whether you are differentiating through the weights or not, as they depend implicitly on \(\theta\)).</p> <p>See the papers for extensions on using AIS bootstrapping to train with other divergences/objectives/models.</p> <p>Here’s one idea I have. As the authors point out, the distribution that minimizes the variance of the self-normalized weights is different than for the unnormalized ones. What if AIS was used to target this distribution instead? In general, this would not be tractable. However, for some divergences it will be, and may improve results even more.</p> <h2 id="replay-buffer">Replay Buffer</h2> <p>The next contribution of Annealed Importance Sampling Bootstrap is to introduce a <em> prioritized replay buffer</em>. Once the parameters \(\theta\) are updated, we could dispose with the old AIS samples, and draw entirely new ones from AIS initialized at the new \(q_{\theta}\) targeting the new \(g_{*}\). This would require invoking the AIS procedure often, which may be very expensive. Instead, the authors propose to keep old samples in a buffer and to adjust the training procedure accordingly. Thus we can rely on the AIS sampling procedure less frequently.</p> <p>Suppose that the replay buffer has samples \(x_i\) with corresponding weights \(w_i\) targeting \(g_{\theta'} \propto \frac{p^2}{q_{\theta'}}\). By rescaling the weights via</p> \[w_i \mapsto w_i \frac{g_{\theta}}{g_{\theta'}} = w_i \frac{q_{\theta'}}{q_{\theta}},\] <p>the existing samples \(x_i\) and updated weights \(w_i \frac{q_{\theta'}}{q_{\theta}}\) now target \(g_{\theta} \propto \frac{p^2}{q_{\theta}}\). Therefore, suppose we store the weights, particles and previous \(q_{\theta'}\) values in the buffer. After we update to the new parameters \(\theta\), we can iterate through the buffer to update the weights and \(q_{\theta'}\) values so that they target the new \(g_{\theta}\). In this way, we can keep old samples and add fresh ones to the buffer without breaking anything. It is also nice that we do not need to reevaluate \(p\) which could be very expensive.</p> <p>The authors also propose that instead of sampling uniformly from the buffer and using the AIS weights to weight the expected values, to rather sample proportional to the normalized AIS weights (and not include a weight in the expected value calculation). This procedure has the same expected value as the self-normalizing objective.</p> <p>Since we are sampling in proportion to the weights \(w \approx \frac{g}{q_{\theta}} = \frac{p^2}{q_{\theta}^2}\), this means that sampling prioritizes samples where the current flow \(q_{\theta}\) under assigns mass relative to the target \(p\). As \(q_{\theta}\) improves on these points, the weights of these particles will decrease, and so the buffer will prioritize other samples instead, providing variability.</p> <p>Iterating through all of the data points in the buffer before sampling is expensive, so the paper discusses some approximations to speed up training at the cost of introducing a small bias.</p> <h2 id="todo">TODO</h2> <p>I want to read some more of the related literature before returning to their RELATED WORK and DISCUSSION sections.</p> </div> </article> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> </body> </html>